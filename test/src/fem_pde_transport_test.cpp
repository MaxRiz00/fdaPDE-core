// This file is part of fdaPDE, a C++ library for physics-informed
// spatial and functional data analysis.
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.

#include <gtest/gtest.h>   // testing framework
#include <cstddef>

#include <fdaPDE/utils.h>
#include <fdaPDE/fields.h>
#include <fdaPDE/mesh.h>
#include <fdaPDE/finite_elements.h>
using fdapde::core::Element;
using fdapde::core::Integrator;
using fdapde::core::LagrangianBasis;
using fdapde::core::FEM;
using fdapde::core::MatrixConst;
using fdapde::core::MatrixPtr;
using fdapde::core::ScalarPtr;
using fdapde::core::VectorPtr;

using fdapde::core::PDE;
using fdapde::core::ScalarField;
using fdapde::core::advection;
using fdapde::core::reaction;
using fdapde::core::diffusion;
using fdapde::core::laplacian;
using fdapde::core::dt;
using fdapde::core::fem_order;
using fdapde::core::make_pde;
using fdapde::core::PDEparameters;
using fdapde::core::DiscretizedMatrixField;
using fdapde::core::DiscretizedVectorField;
using fdapde::core::Divergence;

#include "utils/mesh_loader.h"
using fdapde::testing::MeshLoader;
#include "utils/utils.h"
using fdapde::testing::almost_equal;
using fdapde::testing::DOUBLE_TOLERANCE;
using fdapde::testing::read_csv;

// #include <iomanip>
#include <string>
// tests for Advection Dominated Elliptic Partial Differential Equations
TEST(transport_test, TestCase0) {
    constexpr std::size_t femOrder = 1;

    // define exact solution
    auto solutionExpr = [](SVector<2> x) -> double {
        return 3*sin(x[0]) + 2*x[1];
    };

    SVector<2> b;  b << 1., 1.;
    double mu = 1e-9;

    // non-zero forcing term
    auto forcingExpr = [&mu, &b](SVector<2> x) -> double {
        return 2*b[1] + 3*b[0]*cos(x[0]) + 3*mu*sin(x[0]);
    };
    ScalarField<2> forcing(forcingExpr);   // wrap lambda expression in ScalarField object

    PDEparameters<decltype(mu), decltype(b)>::destroyInstance();
    PDEparameters<decltype(mu), decltype(b)> &PDEparams =
            PDEparameters<decltype(mu), decltype(b)>::getInstance(mu, b);

    auto L = - mu * laplacian<FEM>() + advection<FEM>(b);
    MeshLoader<Mesh2D> unit_square("unit_square_32");

    PDE< decltype(unit_square.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(mu),
            decltype(b)> pde_( unit_square.mesh, L); //, forcing);
    pde_.set_forcing(forcing);

    // compute boundary condition and exact solution
    DMatrix<double> nodes_ = pde_.dof_coords();
    DMatrix<double> dirichletBC(nodes_.rows(), 1);
    DMatrix<double> solution_ex(nodes_.rows(), 1);

    // set exact sol & dirichlet conditions
    for (int i = 0; i < nodes_.rows(); ++i) {
        solution_ex(i) = solutionExpr(nodes_.row(i));
        dirichletBC(i) = solutionExpr(nodes_.row(i));
    }
    pde_.set_dirichlet_bc(dirichletBC);
    pde_.set_stab_param(1.0);
    // init solver and solve differential problem
    pde_.init();
    pde_.solve();

    // check computed error
    DMatrix<double> error_ = solution_ex - pde_.solution();
    double error_L2 = (pde_.mass() * error_.cwiseProduct(error_)).sum();
    EXPECT_TRUE(error_L2 < 1e-7);

    // std::cout << "error_L2 = " << std::setprecision(17) << error_L2 << std::endl;
    // //storing solution
    // std::ofstream file("fdaPDE_SUPG_sol.txt");
    // if (file.is_open()){
    //     for(int i = 0; i < pde_.solution().rows(); ++i)
    //         file << pde_.solution()(i) << '\n';
    //     file.close();
    // } else {
    //     std::cerr << "transport test unable to save solution" << std::endl;
    // }
}

TEST(transport_test, TestCase1) {

    constexpr std::size_t femOrder = 1;

    // define exact solution
    SVector<2> b;
    b << 1., 0.;
    double nu = 1e-9;
    // double c = 0.;

    auto solutionExpr = [&nu](SVector<2> x) -> double {
        return x[0]*x[1]*x[1] - x[1]*x[1]*exp((2*(x[0] - 1))/nu) - x[0]*exp(3*(x[1] - 1)/nu) + exp((2*(x[0] - 1) + 3*(x[1] - 1))/nu);
    };

    // forcing term
    using std::exp;
    auto forcingExpr = [&nu, &b](SVector<2> x) -> double {
        return b[0]*(x[1]*x[1] - exp((3*x[1] - 3)/nu) - 2*x[1]*x[1]*exp((2*x[0] - 2)/nu)/nu + 2*exp((2*x[0] + 3*x[1] - 5)/nu)/nu) + b[1]*(2*x[0]*x[1] - 2*x[1]*exp((2*x[0] - 2)/nu) - 3*x[0]*exp((3*x[1] - 3)/nu)/nu + 3*exp((2*x[0] + 3*x[1] - 5)/nu)/nu) - nu*(2*x[0] - 2*exp((2*x[0] - 2)/nu) - 9*x[0]*exp((3*x[1] - 3)/nu)/(nu*nu) - 4*x[1]*x[1]*exp((2*x[0] - 2)/nu)/(nu*nu) + 13*exp((2*x[0] + 3*x[1] - 5)/nu)/(nu*nu));
    };
    ScalarField<2> forcing(forcingExpr);

    PDEparameters<decltype(nu), decltype(b)>::destroyInstance();
    PDEparameters<decltype(nu), decltype(b)> &PDEparams =
            PDEparameters<decltype(nu), decltype(b)>::getInstance(nu, b);

    auto L = - nu * laplacian<FEM>() + advection<FEM>(b); // + reaction<FEM>(c);

    MeshLoader<Mesh2D> unit_square("unit_square_32");

    PDE< decltype(unit_square.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(nu),
            decltype(b)> pde_( unit_square.mesh, L); //, forcing);
    pde_.set_forcing(forcing);

    // compute boundary condition and exact solution
    DMatrix<double> nodes_ = pde_.dof_coords();
    DMatrix<double> dirichletBC(nodes_.rows(), 1);
    DMatrix<double> solution_ex(nodes_.rows(), 1);

    // set exact sol & dirichlet conditions
    for (int i = 0; i < nodes_.rows(); ++i) {
        solution_ex(i) = solutionExpr(nodes_.row(i));
        dirichletBC(i) = solutionExpr(nodes_.row(i));
    }
    pde_.set_dirichlet_bc(dirichletBC);
    pde_.set_stab_param(1.075);

    // init solver and solve differential problem
    pde_.init();
    pde_.solve();

    // check computed error
    DMatrix<double> error_ = solution_ex - pde_.solution();
    double error_L2 = (pde_.mass() * error_.cwiseProduct(error_)).sum();
    EXPECT_TRUE(error_L2 < 1e-3);

    // std::cout << "error_L2 = " << std::setprecision(17) << error_L2 << std::endl;
    // //storing solution
    // std::ofstream file("fdaPDE_SUPG_sol.txt");
    // if (file.is_open()){
    //     for(int i = 0; i < pde_.solution().rows(); ++i)
    //         file << pde_.solution()(i) << '\n';
    //     file.close();
    // } else {
    //     std::cerr << "transport test unable to save solution" << std::endl;
    // }

}

TEST(transport_test, TestCase2){
    constexpr std::size_t femOrder = 1;

    // define domain
    MeshLoader<Mesh2D> domain("unit_square_32");

    // define vector field containing transport data
    VectorField<2> b_callable;
    b_callable[0] = [](SVector<2> x) -> double { return std::pow(x[1], 2) + 1; };   // y^2 + 1
    b_callable[1] = [](SVector<2> x) -> double { return 2 * x[0]; };                // 2*x

    Integrator<FEM, 2, femOrder> integrator;
    DMatrix<double> quad_nodes = integrator.quadrature_nodes(domain.mesh);

    DMatrix<double, Eigen::RowMajor> b_data(quad_nodes.rows(), 2);
    for(int i = 0; i < quad_nodes.rows(); i++) {
        b_data.row(i) = b_callable(SVector<2>(quad_nodes.row(i)));
    }

    // construct it together with its divergence
    ScalarField<2> div_b_callable = div(b_callable);
    DVector<double> div_b_data(quad_nodes.rows());
    for(int i = 0; i < quad_nodes.rows(); i++) {
        div_b_data(i) = div_b_callable(SVector<2>(quad_nodes.row(i)));
    }

    DiscretizedVectorField<2,2> b_discretized(b_data, div_b_data);

    // coefficients
    double mu = 1e-9;

    // non-zero forcing term
    auto forcingExpr = [](SVector<2> x) -> double { return 1.; };
    ScalarField<2> forcing(forcingExpr);   // wrap lambda expression in ScalarField object

    PDEparameters<decltype(mu), decltype(b_discretized)> &PDEparams =
            PDEparameters<decltype(mu), decltype(b_discretized)>::getInstance(mu, b_discretized);

    // define differential operator
    auto L = -mu*laplacian<FEM>() + advection<FEM>(b_discretized);

    PDE< decltype(domain.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(mu),
            decltype(b_discretized)> pde_( domain.mesh, L); //, forcing );
    pde_.set_forcing(forcing);

    // compute boundary condition and exact solution
    DMatrix<double> nodes_ = pde_.dof_coords();
    DMatrix<double> dirichletBC(nodes_.rows(), 1);

    // set dirichlet conditions
    for (int i = 0; i < nodes_.rows(); ++i) {
        dirichletBC(i) = 0.;
    }
    pde_.set_dirichlet_bc(dirichletBC);
    pde_.set_stab_param(2.285);

    // init solver and solve differential problem
    pde_.init();
    pde_.solve();

    // //storing solution
    // {
    // std::ofstream file("fdaPDE_SUPG_sol.txt");
    // if (file.is_open()){
    //     for(int i = 0; i < pde_.solution().rows(); ++i)
    //         file << std::setprecision(17) << pde_.solution()(i) << '\n';
    //     file.close();
    // } else {
    //     std::cerr << "transport test unable to save solution" << std::endl;
    // }
    // }

    std::vector<double> expected({
        -1.892120740240861e-34, -1.7303852195116085e-34, -2.031601296119556e-34, -2.5981319599139867e-34, -3.1937653801878811e-34, -3.5985252438699928e-34, -3.6726255626473256e-34, -3.4039850670369696e-34, -2.9072735373748266e-34, -2.35926962150705e-34, -1.8973602428554664e-34, -1.5490903896027974e-34, -1.2514522566637629e-34, -9.4357368356064797e-35, -6.2642417889028404e-35, -3.1374459587999602e-35, -3.4088152450962488e-37, 3.0575932152709322e-35, 6.1399770522388093e-35, 9.215329120195257e-35, 1.2285364775760175e-34, 1.5351308139146054e-34, 1.8414077419679399e-34, 2.1474369449618537e-34, 2.4532677752847415e-34, 2.7589127030156507e-34, 3.0644347596045292e-34, 3.3703425848156342e-34, 3.6727340391842701e-34, 3.9087370181762923e-34, 3.6975511627763576e-34, 1.6940798744371557e-34, -1.3215204587705555e-66, 4.5358467544833773e-35, 0.03873968271872405, 0.074313380762387207, 0.10254456047435287, 0.11965877528699513, 0.12360251215388833, 0.1152602929629607, 0.098726420675011223, 0.079994183951867012, 0.064371155164491017, 0.054133224315967281, 0.048203048177492484, 0.044138258115643328, 0.040507970837676509, 0.037292068881421246, 0.03459516267189424, 0.0322814269109334, 0.030264853327844232, 0.028491541303441403, 0.026919159154490287, 0.025514713808763665, 0.024252212922273739, 0.023110827309978765, 0.022073672708242818, 0.021126911197858943, 0.020259042849033005, 0.019460245513066167, 0.018722835932851411, 0.018043666301279054, 0.017384818289574899, 0.01631599173924269, 0.012634480203059991, -1.890362017845788e-34, -6.6417529100718466e-36, 0.029571095177945407, 0.060807106243203887, 0.094996433240941078, 0.13145020317650735, 0.16612598825106767, 0.19178677263826335, 0.20078942525048707, 0.18984537572330612, 0.16358057150386965, 0.13303892139238213, 0.10879992353464987, 0.094221613041233665, 0.085554307891764686, 0.078490169912205282, 0.072219100947922596, 0.066964089969715784, 0.062483069045870858, 0.058594772527098368, 0.055184983605239553, 0.052167256344441963, 0.049475157724694477, 0.047056979271480184, 0.044871670838106288, 0.042886222244568735, 0.041073732304228318, 0.039411622805726181, 0.037880693237585868, 0.036471439532081401, 0.035156077222985783, 0.033335434262889249, 0.02683890419930603, 1.8433714642173188e-34, 6.4428911298778738e-36, 0.031248350785834288, 0.061951771035993829, 0.092023235721334751, 0.12247330748656259, 0.15526455748842566, 0.19137474787699071, 0.2274815853877353, 0.25418387474936255, 0.25967868924657811, 0.23891753981163291, 0.2006952952009074, 0.16298530004721196, 0.13814644202998771, 0.12424889352023955, 0.11385191308271643, 0.10473027277462538, 0.097107781085500472, 0.090634111500888001, 0.085035584266267353, 0.080135863653165371, 0.075804936566324227, 0.071944070244867028, 0.068477170433618562, 0.065344287390145014, 0.062497539082470716, 0.0598977518716306, 0.057510959173593758, 0.055313251654413198, 0.053287994863775848, 0.050825992229005308, 0.042182346263734904, 6.1905055028078622e-34, 8.2694938807864033e-36, 0.030744629488900173, 0.061667678525004099, 0.092718387095143018, 0.12349177569073466, 0.15364774972669412, 0.18397125398741876, 0.21679829451164398, 0.25356745643267575, 0.28943232730467933, 0.31053029050670811, 0.30180161652394333, 0.2630371964860353, 0.21465422996338579, 0.17948431813964164, 0.16018184764077747, 0.14657595298084217, 0.13483388983508987, 0.12506785088198835, 0.11679492853940361, 0.1096570629611217, 0.10341791570431073, 0.097906613205083537, 0.092994571829076791, 0.088583455800914229, 0.084596291968641268, 0.080971707868275553, 0.077657566085057389, 0.074609145843321692, 0.071800796793412849, 0.068669491006122366, 0.058294278260641347, 1.105390882584268e-33, 1.2858308780140975e-35, 0.030511928435254156, 0.061028410817102967, 0.091631062513405914, 0.12246498853553098, 0.15350749034294542, 0.18430783177230126, 0.21445801522331814, 0.24509968965266618, 0.27931413638431446, 0.31750441238717214, 0.34914386963917365, 0.35332234668567136, 0.31834064540728291, 0.26216121403135206, 0.21760724282049651, 0.19328478577883745, 0.17669110765594714, 0.16258755318850923, 0.15092074612145992, 0.14105102323773977, 0.13254725248672847, 0.12511810795742037, 0.11855623929537207, 0.11270660256764235, 0.10745133847494277, 0.1026985745995125, 0.098372996499986501, 0.09440500257470498, 0.090736839092579041, 0.086831478746973001, 0.074890965405405574, 1.6354726435539708e-33, 1.8251431390996139e-35, 0.030196479340514049, 0.060438256797242192, 0.090748741228973681, 0.12114745716477213, 0.15172509585818172, 0.18263735304672543, 0.21378904296070056, 0.24454388251940404, 0.27468746170667085, 0.30658532152391121, 0.34379901536555924, 0.38115852071928369, 0.39635877298851235, 0.36668300478245042, 0.30459940528216661, 0.25206729235830416, 0.22353137806275319, 0.20426622740442171, 0.18808826833190045, 0.174770200255187, 0.16350656552434928, 0.15380694389878813, 0.14533205929534604, 0.13784353667495244, 0.13116382264382742, 0.12515852352943879, 0.11972113875128122, 0.1147532953338354, 0.11014746019085246, 0.10532981546598486, 0.09177796455488034, 2.2042563203235199e-33, 2.4572895921819583e-35, 0.029829580991915763, 0.059705187364705488, 0.089675813389629752, 0.11978336142992228, 0.15004463868210219, 0.18048130913663493, 0.21121792974254699, 0.24240213680055706, 0.27369152067875269, 0.30423323137136871, 0.33491993460597719, 0.37023337481242413, 0.41005505708818601, 0.43370105175943185, 0.40889292883788014, 0.34164475559547025, 0.28270105381455707, 0.25097635808913066, 0.22940973221694586, 0.21146326537809018, 0.19673936475268983, 0.18427810460427396, 0.17354463526736746, 0.16416001438870642, 0.15586073806067344, 0.14845083714151816, 0.14178054264643966, 0.13571617072129982, 0.13008853232043388, 0.12420964764630599, 0.10883748630060663, 2.809805237625655e-33, 3.1854155659703139e-35, 0.029418846979123177, 0.058888287330731766, 0.088457445480993518, 0.11817552390017175, 0.14809213484453687, 0.17824093653650008, 0.20862332681917486, 0.23928074016980203, 0.27040109641201915, 0.30198669775055959, 0.33317578971177714, 0.36358386119822611, 0.39716933273193183, 0.43765606842924359, 0.46745290364825365, 0.44586506201291304, 0.3733235895758561, 0.3096113258050987, 0.27575431264152089, 0.25226548751599515, 0.23286082330324331, 0.21696338103981103, 0.20348889446342164, 0.19187217742040039, 0.18170339564368659, 0.17269956705177439, 0.16464831940436342, 0.15736933505666326, 0.15062163745203144, 0.14352761570375164, 0.12600936357889497, 3.4530198716140245e-33, 4.0081116020504126e-35, 0.028966349306362566, 0.057987269542027486, 0.087116522881218281, 0.11640563119641206, 0.14590343133269296, 0.17565915212810559, 0.20571822631519418, 0.23609330816178234, 0.26677274219811953, 0.29787425510138743, 0.32960273568674209, 0.36139474095407204, 0.39208624996056829, 0.42444327266111942, 0.46481063877512624, 0.49900827630228378, 0.47824104292831621, 0.39986261567223325, 0.33310046207293376, 0.29805621969409146, 0.27300446517321281, 0.25244124218760011, 0.23558285351871863, 0.22126407729256978, 0.20890108333082555, 0.19806143627817965, 0.18844539467813276, 0.17980633087874995, 0.17181811638959546, 0.16334486089336181, 0.14327240669666111, 4.1371114651229746e-33, 4.9255848178542403e-35, 0.028476776635598288, 0.057011177565459821, 0.0856601966168649, 0.11447960607344024, 0.1435228277591552, 0.17283921883112607, 0.20247535806978254, 0.23247889820223058, 0.262879637257661, 0.29365340707454357, 0.32482707740763955, 0.35665629297344237, 0.38893436783522611, 0.42018706422290131, 0.45178935530262365, 0.49189153129594937, 0.5291797926404298, 0.50632969801720662, 0.42163021310931242, 0.35359188204640862, 0.31810151231948114, 0.29181442907118971, 0.27036866986326086, 0.25273845707368497, 0.23772665045428981, 0.22473869675505923, 0.21332377788435344, 0.20314366410770554, 0.19376425120484597, 0.18372666890796577, 0.16063017720815781, 4.8670395053431838e-33, 5.9377976080643526e-35, 0.027954521921093888, 0.055969065897342254, 0.084103139653879541, 0.11241526861676429, 0.14096246022495981, 0.16979941165727808, 0.19897659209986202, 0.2285388693475125, 0.25853055087010979, 0.28899178625009569, 0.31991012546953185, 0.35124502872811819, 0.38320537874427979, 0.41587216636032653, 0.44780366466099319, 0.47897416615103194, 0.51908805489579324, 0.55831099769797632, 0.53016623214803726, 0.43912596132797482, 0.37155521474154923, 0.3361158855534519, 0.30888969327214261, 0.2868043905191438, 0.26856649557501577, 0.25299299957591714, 0.23947852551785803, 0.2275274713507727, 0.21656707716214363, 0.20474623371514922, 0.1781026200660723, 5.6490685984039714e-33, 7.0447193067892951e-35, 0.027404024330420992, 0.054869782122399832, 0.082458631858126463, 0.11023126756779356, 0.13824724923404616, 0.16656443282702554, 0.19523831799276845, 0.22432049559914985, 0.2538556467126093, 0.28388357902288858, 0.31444612088155011, 0.34554958179849821, 0.37711891388051461, 0.40927425165659981, 0.44227578585024363, 0.4749285720336518, 0.50582854981498682, 0.54654674328458874, 0.58634341622629993, 0.54964639068013366, 0.452973355581407, 0.38744370292294006, 0.35231799868743074, 0.32442208783728721, 0.30190149204104366, 0.28319361338303412, 0.26716010543310609, 0.25314442865207182, 0.24036106084201306, 0.22649068692612531, 0.19572313841154876, 6.4905251211629141e-33, 8.24633938472543e-35, 0.02682969338964028, 0.053722187975197108, 0.080740029967930629, 0.10794539060308207, 0.13539976963850431, 0.16316354456603085, 0.19129532481059439, 0.21985122761461678, 0.24888371614944554, 0.27843825806708133, 0.30855138187589537, 0.33926064463954209, 0.37058797690944811, 0.4024501152562065, 0.43487194216842506, 0.46819892228753246, 0.50157221557255893, 0.53226186154688404, 0.57440153343380995, 0.61286858389296406, 0.56468674866504054, 0.46388902399863469, 0.40165020770521437, 0.36691365228511591, 0.33859313671935176, 0.3157984031120406, 0.29671980568771655, 0.28023266483560233, 0.26531815140697101, 0.24906837507043139, 0.21353985351939195, 7.3997713807997316e-33, 9.5426518177999113e-35, 0.026235822676834497, 0.052534920754477028, 0.078960420762650016, 0.10557532578891628, 0.13244236102109722, 0.15962370178691215, 0.18718052058355367, 0.21517226550758947, 0.24365574310587584, 0.27268409291827284, 0.30230388201780833, 0.33255018979122231, 0.36345359540072197, 0.39504496641715725, 0.42724862564997962, 0.4600015190008267, 0.49368866188198179, 0.52772654860621682, 0.55828363388775115, 0.60272447934295981, 0.6372060007120216, 0.57536662433668717, 0.47262432669747084, 0.41448486135327645, 0.38009347583025849, 0.35156421437976282, 0.32859649366856097, 0.30912324270031261, 0.29165734314790198, 0.27261885500046368, 0.23161961322695496, 8.3863834140143664e-33, 1.093365770338728e-34, 0.025626536456616562, 0.051316284375425819, 0.077132397915502957, 0.10313812546741813, 0.1293967788015136, 0.15597160185672884, 0.18292549622771306, 0.21032054479169351, 0.23821722336200701, 0.2666732621275511, 0.29574246950484007, 0.32547241729587462, 0.3558983424137348, 0.38704306322632087, 0.41894087295451682, 0.45152917869362413, 0.48466505662697046, 0.51878952428713654, 0.55335069579123086, 0.58402283435508806, 0.63143292873824242, 0.65852951561678041, 0.58201509642674498, 0.47989208742172407, 0.42617182149484029, 0.39202630318893805, 0.36344518327335068, 0.3402365349038407, 0.31968106388389278, 0.29732189715123059, 0.25005494028199854, 9.4614911025661526e-33, 1.2419364207900045e-34, 0.025005742702730271, 0.050074155103578336, 0.075267926398016508, 0.10065002249078206, 0.12628376126144519, 0.15223280587515145, 0.17856103735027753, 0.20533225953286871, 0.2326096794383111, 0.26045505243117545, 0.28892734551522103, 0.31808122292314567, 0.34796497519292441, 0.37861542969610434, 0.41004651750783788, 0.4422960877426847, 0.47530681088963278, 0.50886878658864121, 0.54353733772738133, 0.57838338630250852, 0.60972054360197248, 0.66019897748766843, 0.67603383911145765, 0.58522362266617345, 0.48629669800409997, 0.4368528527336546, 0.40282038615507981, 0.37413350524919903, 0.34978261733951743, 0.32342794869218883, 0.26897042142163641, 1.0638372279583911e-32, 1.3999784426232552e-34, 0.024377097493542572, 0.048815907364616024, 0.073378224108079829, 0.098126267382481633, 0.12312284504944593, 0.14843145162858237, 0.17411627058109017, 0.20024203901460749, 0.22687372158752434, 0.25407593175720511, 0.28191199920821131, 0.31044246695798083, 0.33972320833612085, 0.36980273112373913, 0.40072163140538875, 0.43247992600650359, 0.46513181154900579, 0.49859241060856851, 0.53262920541443082, 0.56794421229033254, 0.60278077359366189, 0.63567764085252132, 0.68840648867963694, 0.68910609717506577, 0.58578537337356651, 0.49227544822731151, 0.446555474472971, 0.41231561201322631, 0.38243355097466813, 0.35127568350774763, 0.2885429848328715, 1.1932992413080353e-32, 1.5674934084114502e-34, 0.023743978893368115, 0.047548359201317579, 0.071473673978634619, 0.09558099809029344, 0.11993218163760526, 0.14459003426712208, 0.16961843535812937, 0.19508233686438428, 0.22104761380701249, 0.24758070165738161, 0.27474794797090946, 0.30261458400874619, 0.33124306146460719, 0.36069101133653036, 0.39100601746385105, 0.42223741946936444, 0.45435646605521723, 0.48747142288602241, 0.52138936717684814, 0.55597705140654363, 0.5919835897338227, 0.62656580769846348, 0.66215933739407162, 0.71518230296737595, 0.69745430023549493, 0.58457175993405697, 0.49801409134805458, 0.45494671144460275, 0.41900280156105602, 0.38123713535621595, 0.30902195695979878, 1.3365542474235074e-32, 1.7444839002632515e-34, 0.023109473665127327, 0.04627774462508967, 0.069563779115192875, 0.093027172663513485, 0.11672843778652835, 0.14072925613352077, 0.16509267595355734, 0.18988322873030061, 0.21516692905276633, 0.24101110821242075, 0.26748401274656342, 0.29465408065100335, 0.32258880004672558, 0.35135282037214105, 0.38100645020243262, 0.41159355522457541, 0.44318366172470286, 0.47568488449864971, 0.50934204793705551, 0.54369243623062047, 0.57895488348566748, 0.61558731626209384, 0.64986595868909713, 0.68927996373932487, 0.73949334681743217, 0.70113851301167962, 0.58231962426735506, 0.50312159888547736, 0.46003023018034905, 0.41444951069132968, 0.33066542292206663, 1.4963092910496708e-32, 1.930950687662575e-34, 0.022476362055793068, 0.045009679989078878, 0.067657106131628938, 0.090476484077166255, 0.11352667610003288, 0.13686786645363674, 0.16056182657911416, 0.1846721224728802, 0.20926423623820617, 0.23440556250638211, 0.26016522493898592, 0.28661363567446879, 0.31382169404359589, 0.3418595292008057, 0.37079415823054507, 0.40069026524468748, 0.43158176417749716, 0.46358209657557281, 0.4964673806181657, 0.53077667847361498, 0.56548853037985436, 0.60160647028998482, 0.63866209268471485, 0.67291680512500596, 0.71689722156695757, 0.76024963150586744, 0.70040719692808917, 0.57909403723276665, 0.50506995702384139, 0.4517342654531441, 0.3542406722266021, 1.6752571760134655e-32, 2.1269019962731121e-34, 0.021847142827000215, 0.043749218657491623, 0.065761372960519343, 0.087939480994381661, 0.11034050218859105, 0.1330228201562233, 0.15604655878995519, 0.17947386010674723, 0.2033691026766182, 0.22779902998766149, 0.25283274518037646, 0.27854151121916237, 0.30499827065851848, 0.33227676415710433, 0.36045019217775359, 0.38958784856339962, 0.41976194475072887, 0.45098416327796798, 0.48345609879511964, 0.51669655356968425, 0.55181829776787639, 0.58675697143492223, 0.62396019611948028, 0.66112195359734693, 0.69601649911035701, 0.74451267466632476, 0.77624625143510195, 0.69499900262828418, 0.57228711411606004, 0.49189294985760884, 0.38056778166215732, 1.8797647257633866e-32, 2.3323209784140256e-34, 0.021223957276887629, 0.042500681455620283, 0.063883167520635789, 0.085425162834640467, 0.10718153740503104, 0.12920864680436872, 0.15156468173074877, 0.1743099948431141, 0.19750739045965721, 0.22122235517922748, 0.24552319653301902, 0.27048104143938312, 0.29616962573958711, 0.32266477779761671, 0.35004345112303586, 0.37838242575739017, 0.40775270982317996, 0.43823952170843289, 0.46981088634965795, 0.50283143961628718, 0.53635062075117546, 0.5725284366540816, 0.60746504060997408, 0.64600970915232536, 0.68291883261992203, 0.71940732239007521, 0.77104714789788664, 0.78543340774534576, 0.681521584594036, 0.54818140529459425, 0.40856464384650504, 2.118768741799742e-32, 2.5472811052989478e-34, 0.020608872694508285, 0.04126827581630442, 0.062028954374832947, 0.082942402681640631, 0.10406124180926114, 0.12543959762310269, 0.14713347659253626, 0.16920113289521774, 0.19170341540304689, 0.21470407698851246, 0.2382700208475467, 0.26247144801513372, 0.28738185488466989, 0.31307780715796524, 0.33963838400635382, 0.36714410277429904, 0.39567594188500649, 0.42530532310282065, 0.45613903325413746, 0.48806819919941213, 0.52173598075307737, 0.55538568797883603, 0.59300295559136695, 0.62755330169028445, 0.66768659770650252, 0.70402443062667275, 0.7429625959277566, 0.79392725108411788, 0.78173223378338363, 0.64330255196407782, 0.44577503005685742, 2.3849245176810674e-32, 2.7715258513671829e-34, 0.020002967751838546, 0.040054100713782383, 0.060201832338045332, 0.080495361756714387, 0.1009850288907269, 0.12172268894145497, 0.14276208472883772, 0.1641592160297807, 0.18597270448235267, 0.20826414889830033, 0.23109845740389279, 0.25454412934392345, 0.27867344222296098, 0.3035624781183005, 0.32929089983031579, 0.35594135658591031, 0.38359823317913183, 0.41234749089959971, 0.44225877393383378, 0.47347222789878873, 0.50575663828679085, 0.54019467338966876, 0.57372220675039509, 0.61339678063538439, 0.64689966025513379, 0.68878657738045312, 0.72421318363391929, 0.76513322046878218, 0.80542826417614355, 0.74290202899420288, 0.51038644310419012, 2.7268310298961525e-32, 3.0060357133547306e-34, 0.019409587437748746, 0.038865188422084161, 0.058412901863505375, 0.078099491190972051, 0.097972759536446088, 0.11808194501954047, 0.1384781396680102, 0.15921472556130911, 0.18034781184663462, 0.20193665015778034, 0.22404400629088209, 0.24673647117855824, 0.27008469740793606, 0.29416353934483136, 0.31905204898227352, 0.34483323749982997, 0.37159346663412002, 0.39942095633938801, 0.42840727617040431, 0.45861697471205287, 0.49023709610462884, 0.52286076304501417, 0.55820764906491216, 0.59121547332537172, 0.63395221489791043, 0.6652248067962081, 0.7086966200164162, 0.74209124204372678, 0.77906449960769175, 0.77904920891882967, 0.5856426481161181, 3.2895669300442659e-32, 3.247039078419534e-34, 0.018822802453718906, 0.03768868716714404, 0.056641395762511995, 0.075725594014753761, 0.094987208222843969, 0.11447372990320223, 0.13423448151329401, 0.15432086173684431, 0.17478661128407227, 0.19568814644283411, 0.21708498852393096, 0.23904027595657765, 0.2616212985385607, 0.28489996028386605, 0.30895306804652484, 0.33386234998575332, 0.35971411308406043, 0.38659845797077058, 0.41460720816999391, 0.44383797062323727, 0.47434613893246619, 0.50637747063253602, 0.5393002344203297, 0.57566943865103659, 0.60757143109036438, 0.65499237997252191, 0.68179795665307763, 0.72537262807611469, 0.75134355441152256, 0.75850846600508182, 0.62090386572936573, 3.9853410951537937e-32, 3.5094880853136611e-34, 0.018269724783763125, 0.036582260726185964, 0.054979134787477998, 0.073501755788546563, 0.09219184917930541, 0.11109202923232026, 0.13024654409544559, 0.14970214053551312, 0.16950891707367299, 0.18972099966857228, 0.21039690834868924, 0.23159958438906789, 0.25339617748583332, 0.27585778587556276, 0.29905933842422566, 0.32307968866001952, 0.34800180424505806, 0.37391277538196566, 0.40090337540894544, 0.42906556708718024, 0.45850037158426038, 0.48924819528854724, 0.52161669442790171, 0.55472490516735329, 0.59208540104634644, 0.62206611038182258, 0.67671018975111197, 0.69442996649874367, 0.73165140988537691, 0.72716404375884769, 0.60864564955285438, 4.4453909421520999e-32, 3.7326440031232106e-34, 0.017651783836721242, 0.035337156348448563, 0.053094899825161121, 0.070967318024494991, 0.089000185285211683, 0.10724228573377682, 0.12574442007031988, 0.14455804042110182, 0.16373394376679504, 0.18332158579453853, 0.20336945002666432, 0.22392652349607539, 0.2450444615696124, 0.26677973364478313, 0.28919510561297529, 0.31236017976568686, 0.3363511167103837, 0.36124984171178481, 0.38714293322895682, 0.41412032374059382, 0.44227146507083764, 0.47169749273097672, 0.5024193394954658, 0.53479513114466126, 0.56772465530336103, 0.60560011878650022, 0.6325781729990364, 0.69811585067090343, 0.69598275423568956, 0.7024787534975685, 0.5796226022907861, 4.5777169877912172e-32, 4.1695708813592031e-34, 0.017356049601703068, 0.03476797144464315, 0.052274416358515617, 0.0699039420503621, 0.08767677367352332, 0.10560789668390543, 0.12371198504956968, 0.14200946850401908, 0.16053223935893279, 0.17932729870048905, 0.19845711663596138, 0.21799646334199149, 0.23802658478578656, 0.2586284373210469, 0.27987698204166461, 0.30183819976409754, 0.32456961357938025, 0.34812391820959521, 0.37255418171883842, 0.39791848559155335, 0.42428245021916405, 0.45171572896334444, 0.48030752358410128, 0.51005647818001409, 0.54134057754598885, 0.57295598924777413, 0.60974610182884292, 0.63231921971622562, 0.71296190065026022, 0.66257335646636573, 0.55244303734051847, 4.5833820672361206e-32, 3.7325628167171703e-34, 0.015841195085073662, 0.031648183721549546, 0.047445781093385826, 0.063304104819083634, 0.079328441437675215, 0.095647743407872687, 0.11239817846018733, 0.12970140600270752, 0.14764119121427441, 0.16624509252211689, 0.18547850126898927, 0.20525525131741632, 0.22546305562388949, 0.24599576446383059, 0.26678125417024806, 0.28779578748283152, 0.30906218239371785, 0.33063651442516606, 0.35259211521491601, 0.37500829256048507, 0.39796608175881693, 0.42154879483913033, 0.44583913989085106, 0.47093770373148064, 0.49685186487576105, 0.52394524347515115, 0.55113570222798858, 0.58284078648445992, 0.59917202911512835, 0.69565412702827545, 0.51520953016393145, 4.5871425252666735e-32, 7.357088445348099e-34, 0.019489222932110948, 0.039177262556363716, 0.059215637633950123, 0.079550181929195218, 0.099944829339477209, 0.12003792731344719, 0.13942640207547605, 0.15776106436418685, 0.17482797434678485, 0.19059130597312329, 0.20518457145637864, 0.21885585729158613, 0.23189043897974712, 0.24454156558976786, 0.25699303016854635, 0.26935934619796842, 0.2817112641537346, 0.29410606479106766, 0.30660666371751544, 0.31928554992937713, 0.33221965521203084, 0.34548453084227554, 0.35915236086901925, 0.37328921210304267, 0.38797080941023587, 0.40320177232024151, 0.41922667373155403, 0.43534772779442149, 0.45430040548550799, 0.46220276254358278, 0.55587740631939342, 4.5671830991726503e-32, -4.6300566522008261e-66, -2.2336722354148812e-34, -2.2606701750504288e-34, -1.7839115211961706e-34, -6.9152335951302585e-35, 1.13165790853438e-34, 3.7823118884054708e-34, 7.3187094635317437e-34, 1.1749998711151292e-33, 1.7040354119791853e-33, 2.3128507594480121e-33, 2.9956424120627206e-33, 3.7495994459102926e-33, 4.5762894217063586e-33, 5.4812905742968743e-33, 6.4724956952141548e-33, 7.5581549161524138e-33, 8.7457073008871847e-33, 1.0041813367439791e-32, 1.1453217211931891e-32, 1.2987685373193588e-32, 1.4654479334189903e-32, 1.6464331652038822e-32, 1.8429239654072562e-32, 2.0562405363024868e-32, 2.2877991969690397e-32, 2.5392457160291809e-32, 2.8118385951399246e-32, 3.1086270269170217e-32, 3.4267578157873167e-32, 3.7807559390495052e-32, 4.142575490720692e-32, 4.5070454137574892e-32
    });

    for (std::size_t i = 0; i < expected.size(); ++i) { EXPECT_TRUE(std::abs(pde_.solution()(i)-expected[i]) < 1e-6); }
}

TEST(transport_test, TestCase3){
    constexpr std::size_t femOrder = 1;

    // define domain
    MeshLoader<Mesh2D> domain("unit_square_32");

    // define vector field containing transport data
    VectorField<2> b_callable;
    b_callable[0] = [](SVector<2> x) -> double { return std::pow(x[1], 2) + 1; };   // y^2 + 1
    b_callable[1] = [](SVector<2> x) -> double { return 2 * x[0]; };                // 2*x

    Integrator<FEM, 2, femOrder> integrator;
    DMatrix<double> quad_nodes = integrator.quadrature_nodes(domain.mesh);
    DMatrix<double, Eigen::RowMajor> b_data(quad_nodes.rows(), 2);
    for(int i = 0; i < quad_nodes.rows(); i++) {
        b_data.row(i) = b_callable(SVector<2>(quad_nodes.row(i)));
    }

    // construct it together with its divergence
    ScalarField<2> div_b_callable = div(b_callable);
    DVector<double> div_b_data(quad_nodes.rows());
    for(int i = 0; i < quad_nodes.rows(); i++) {
        div_b_data(i) = div_b_callable(SVector<2>(quad_nodes.row(i)));
    }

    // coefficients
    DiscretizedVectorField<2,2> b_discretized(b_data, div_b_data);
    double mu = 1e-5;
    double c = 1.;

    // non-zero forcing term
    auto forcingExpr = [](SVector<2> x) -> double { return 1.; };
    ScalarField<2> forcing(forcingExpr);   // wrap lambda expression in ScalarField object

    PDEparameters<decltype(mu), decltype(b_discretized), decltype(c)> &PDEparams =
            PDEparameters<decltype(mu), decltype(b_discretized), decltype(c)>::getInstance(mu, b_discretized, c);

    // define differential operator
    auto L = -mu*laplacian<FEM>() + advection<FEM>(b_discretized) + reaction<FEM>(c);

    PDE< decltype(domain.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(mu),
            decltype(b_discretized), decltype(c)> pde_( domain.mesh, L); //, forcing );
    pde_.set_forcing(forcing);

    // compute boundary condition and exact solution
    DMatrix<double> nodes_ = pde_.dof_coords();
    DMatrix<double> dirichletBC(nodes_.rows(), 1);

    // set dirichlet conditions
    for (int i = 0; i < nodes_.rows(); ++i) {
        dirichletBC(i) = 0.;
    }
    pde_.set_dirichlet_bc(dirichletBC);
    pde_.set_stab_param(2.85);

    // init solver and solve differential problem
    pde_.init();
    pde_.solve();

    // //storing solution
    // std::ofstream file("fdaPDE_SUPG_sol.txt");
    // if (file.is_open()){
    //     for(int i = 0; i < pde_.solution().rows(); ++i)
    //         file << std::setprecision(17) << pde_.solution()(i) << '\n';
    //     file.close();
    // } else {
    //     std::cerr << "transport test unable to save solution" << std::endl;
    // }

    std::vector<double> expected({
        -1.7823018869905916e-34, -1.4976491316211812e-34, -1.6756393355988269e-34, -2.1160795722738202e-34, -2.5982560900933677e-34, -2.9252022870906406e-34, -2.9705368869139163e-34, -2.711334846978221e-34, -2.2275092660035249e-34, -1.6579963111366407e-34, -1.1279389538784026e-34, -6.8763298795922717e-35, -3.0496567897000179e-35, 7.5343717957985335e-36, 4.6358513945630685e-35, 8.4955696174141578e-35, 1.2334479964485235e-34, 1.6163093576921286e-34, 1.9984153785287783e-34, 2.379976859581638e-34, 2.7611428271330251e-34, 3.1420192950799098e-34, 3.5226802250642851e-34, 3.9031669035816401e-34, 4.2834649194546867e-34, 4.6634051564072517e-34, 5.0418935943252164e-34, 5.411327395163328e-34, 5.7289396718818914e-34, 5.8130270564422612e-34, 5.0851378477961683e-34, 2.2061691574787629e-34, -2.6698767952317399e-66, 1.903584467961133e-34, 0.037600507925984454, 0.070993509038877189, 0.09655471074711959, 0.11137767896077601, 0.11431451087978831, 0.1067304411543032, 0.092401926997667791, 0.07628513672447805, 0.062569209372542026, 0.053096011243699962, 0.047215147302441182, 0.04314473655403385, 0.039665670139661893, 0.036602461275990622, 0.034000559594360928, 0.031762181828524777, 0.02980808061165122, 0.02808649596596707, 0.026557404418618358, 0.02518960376607416, 0.023958394265750728, 0.022843948827657501, 0.021830139007147319, 0.020903641765367742, 0.020053186233284195, 0.019268642059140709, 0.018536988146037197, 0.017816790151160944, 0.016922560502077168, 0.015168738620456002, 0.010685509553498059, -2.0066607627594998e-34, 1.1547376116124545e-34, 0.029481368829849804, 0.059596116522759771, 0.091285652756557839, 0.12364117440404751, 0.15303312943097305, 0.17366071903707694, 0.1800202597073717, 0.1703830016900916, 0.14889236479030687, 0.12399680918981186, 0.10355281786405884, 0.09033917468797778, 0.082022326598231929, 0.075432185656671161, 0.069664543537260259, 0.064765710144295344, 0.060564627493112762, 0.056905248290785991, 0.053684690456004366, 0.050825224238274951, 0.048267044867997058, 0.045963259286480235, 0.043876487341509479, 0.041976411953060899, 0.040237800692352367, 0.03863847448161753, 0.037153963529336011, 0.035722984136519982, 0.034060283437604845, 0.030955973274279843, 0.022537688071172141, 1.496361667974563e-34, 1.3060781210733323e-34, 0.030628287219449355, 0.059889582367263446, 0.087881868238152264, 0.11557493135419332, 0.14446410979660532, 0.17489258140482, 0.20373252363239763, 0.22370634875339324, 0.22664900913760141, 0.20986392048904065, 0.18022756911907939, 0.1504952329014656, 0.12961977122921819, 0.11695920728792032, 0.10754597080148504, 0.099420733906511349, 0.092534158591703969, 0.086639986279692369, 0.081512719742108206, 0.077002237001217472, 0.07299685687074535, 0.069411586872506523, 0.066180280760663041, 0.063250415360838183, 0.060579127687805795, 0.058129359959214685, 0.055862798580782594, 0.053702790106255886, 0.051310276792102615, 0.047095504639927704, 0.03522296343869339, 5.5217701658510117e-34, 1.3388336849431999e-34, 0.030310023086930281, 0.059817509456096714, 0.0884629975973589, 0.11597642222756696, 0.14228486843776783, 0.16823341336663511, 0.19555157186495992, 0.22473560974818169, 0.2514847613338948, 0.26579241817314636, 0.25800338582958759, 0.22896231550945267, 0.19275472463430632, 0.16493837138058942, 0.14820621037097251, 0.13627763460650016, 0.12612716977834518, 0.11755359566537599, 0.1102231185509276, 0.10384974081347206, 0.098242076931094727, 0.093259291152847659, 0.088795094005994446, 0.08476713228196156, 0.081109718931382593, 0.077767219428917886, 0.074683768358469918, 0.071763170687143427, 0.068626630101750311, 0.063405284760299413, 0.048435860102297265, 9.9928428599831114e-34, 1.3923762213714156e-34, 0.030045413407801553, 0.059212302461138101, 0.087596686917613284, 0.1152958258219951, 0.1422418053927097, 0.16812376879375107, 0.19287665041824273, 0.21763341491099925, 0.24444363372444095, 0.27270692591391926, 0.29434741755114591, 0.29563181726188631, 0.27000092536380355, 0.22972275967684405, 0.19618138891765802, 0.17598515243519197, 0.16190261744082551, 0.15004939468088385, 0.14007343268231268, 0.13154528682535757, 0.12412891343452108, 0.11759879417442393, 0.11179027211386759, 0.10657969917053173, 0.10187096921189215, 0.097584739976963306, 0.093643244724570113, 0.089923424508335403, 0.086000180258222744, 0.079775547741849598, 0.061921703327117585, 1.4840904251338681e-33, 1.4593428600398897e-34, 0.029743770044867467, 0.058640742692006309, 0.086741538110546038, 0.11410158968244953, 0.14081544140103822, 0.16696291467314139, 0.1923962530805077, 0.21672023789956696, 0.24013262738891594, 0.26453483163329272, 0.29176123938106252, 0.31712167960251708, 0.32575637445280176, 0.30426348723369506, 0.26137582223092842, 0.22340707016039071, 0.20054062191890132, 0.18469880273992739, 0.17145368258978738, 0.1603383089708379, 0.15082935454449548, 0.14255259419552579, 0.13525590856674979, 0.12875609321543918, 0.12291525914744618, 0.11762285634577488, 0.11277373188814158, 0.10820994343607879, 0.10344299495508692, 0.096151372508701205, 0.075485137972128052, 2.0013890264694329e-33, 1.5375195360342468e-34, 0.029388273781077934, 0.057957076231631537, 0.085769814842607206, 0.1128774337990687, 0.13931687802889053, 0.16514075292409283, 0.1904500746730883, 0.21527196423080025, 0.23928304036058987, 0.26210316662768879, 0.28480968112572197, 0.31021745787770694, 0.33692187249434408, 0.35087046678431416, 0.33295515704396955, 0.28804200636112998, 0.24685509207939352, 0.22215535454037039, 0.2049448984285947, 0.19060047793081755, 0.17858283365818964, 0.16828609283151613, 0.1593102466366976, 0.15138373405894887, 0.14430890831673132, 0.13793280194363872, 0.13211515891841588, 0.12665461451934831, 0.12097836963414035, 0.11251498026204394, 0.088987998763170637, 2.5480278991636707e-33, 1.6275578534061025e-34, 0.028989123785010382, 0.057185812354596542, 0.084655938253795512, 0.11145871087125921, 0.13764430939346647, 0.16324601881470238, 0.18828694978239208, 0.21283061174012813, 0.23697863761149557, 0.26059651292910863, 0.28312635038980594, 0.30480430949349158, 0.32843309888534677, 0.35518692846425248, 0.37271558864954096, 0.35713384264787612, 0.31019693958175765, 0.26689487011060686, 0.24113893470465275, 0.22291570796716587, 0.2077389362885734, 0.19502760151473786, 0.18411148399683017, 0.17457628532061617, 0.16613640984270334, 0.15857886989341605, 0.15171689166247834, 0.14529545395787163, 0.13863574368109222, 0.12887108071563716, 0.10234075897764876, 3.1229333959949839e-33, 1.7294142332491296e-34, 0.028549707522186454, 0.056335970493170656, 0.083426795137374124, 0.10988257884379528, 0.13575651912025954, 0.16109480394136202, 0.18593070833430436, 0.21027610991407558, 0.23415220829463085, 0.25765515963846686, 0.28080555720483191, 0.30311072804747469, 0.32420148580821445, 0.34635688827539801, 0.37259470361527686, 0.39239340645719245, 0.37756602826473074, 0.32835465807323488, 0.28396553593716944, 0.25780709814783631, 0.23887580582234449, 0.22310245168954987, 0.20987630249353426, 0.19848444163764895, 0.18850665178884046, 0.17964230088494715, 0.17164038946127461, 0.16417848710872177, 0.15644930661319131, 0.1452367273968512, 0.11549145870183047, 3.726891197485531e-33, 1.8430706285560758e-34, 0.02807399493703135, 0.055414473551000112, 0.082091243809020664, 0.10816661461550342, 0.13369511593703745, 0.1587235161366293, 0.18329183788649009, 0.20743146801767759, 0.23115291970246848, 0.2544501012585792, 0.27737808945548592, 0.30003906842889905, 0.32210049672682584, 0.34285202710148244, 0.36385220712117833, 0.3894551126911634, 0.41053427659876818, 0.39473485514100709, 0.34303103242262623, 0.29852529940224565, 0.2724627783291077, 0.25307361936855888, 0.23690519170638305, 0.22331317999524317, 0.21156271272630497, 0.20122694295695251, 0.19196280926435097, 0.18336040747461951, 0.17445901471781228, 0.16163573991901628, 0.12841507676132222, 4.3622096700339064e-33, 1.9685331139169944e-34, 0.027566272686096766, 0.054429592415640077, 0.080660889735438043, 0.10632381630254664, 0.13147466844800126, 0.15616210771182726, 0.18042677464387091, 0.20430192574728925, 0.22781434699469111, 0.25097533860071791, 0.27376688451302161, 0.29619807859974234, 0.31839041221783604, 0.34017733743758, 0.36071442567933298, 0.38080332049905813, 0.40592375229480826, 0.42742839354026912, 0.40891592888948169, 0.35474093449082478, 0.31101306103395604, 0.28538335191718062, 0.26573675050434753, 0.24933889576239557, 0.23549800020167222, 0.22346808379602795, 0.21278213680951935, 0.20291205050671657, 0.19271306003501024, 0.17809692278837494, 0.14110514412725569, 5.032372779514453e-33, 2.1058035625338358e-34, 0.027030818248933539, 0.053389597618770809, 0.079147813282182955, 0.10436989533930141, 0.12911326179702567, 0.15342824817022049, 0.17735783605660307, 0.20093703359758594, 0.22419271071171679, 0.24714539631142657, 0.2698055156114002, 0.2921527692811054, 0.31415886044796942, 0.33592661452077477, 0.35742321512285213, 0.3777990968853398, 0.39714291621355502, 0.4220973782304947, 0.44311406843316625, 0.42027515850821967, 0.36399981640303047, 0.32182164925963053, 0.29681410144834963, 0.27706764982816917, 0.26056643332893092, 0.2465475727906154, 0.23422507838547085, 0.22292311335377946, 0.21127134515524396, 0.19465503127374392, 0.15356831076059785, 5.7417594841081776e-33, 2.2548843513287763e-34, 0.026471872748595998, 0.052302687477185222, 0.07756392711084123, 0.10232031839173869, 0.12662994656982288, 0.15054425378161421, 0.17410791383429144, 0.19735853684239876, 0.22032596878415792, 0.24303141469794889, 0.26548871505223881, 0.28770478722373749, 0.30966153200347257, 0.33130367032740704, 0.35269926419290148, 0.37391108086127706, 0.39413159491557498, 0.41285915511173071, 0.43803644836653621, 0.45744524858868907, 0.42896148671392781, 0.37131529386835926, 0.33128162931446775, 0.30696486845055199, 0.28723509646869444, 0.2706986576049108, 0.25646117354230974, 0.24350917164911159, 0.23021003238471496, 0.21135359734917825, 0.16582177926070013, 6.4954739547237994e-33, 2.415778741450364e-34, 0.025893578239195275, 0.051176896607956192, 0.075920952366354863, 0.10019031195196777, 0.12404330327848727, 0.14753208536712517, 0.17070257670030661, 0.19359423685245697, 0.2162396985728961, 0.23866405240872038, 0.26088353503573108, 0.28290569471042082, 0.30473143024739929, 0.32634719038753468, 0.34767582808677594, 0.3687518828283301, 0.38970448453118994, 0.40973339396437969, 0.42799839432789388, 0.45374654457121155, 0.47015929101748971, 0.43517599580507804, 0.37716656047320568, 0.3396529682317444, 0.31600234935337579, 0.29634492721276695, 0.27970397649625178, 0.26482472697204212, 0.24962789350044151, 0.22824913472859357, 0.17789310841637071, 7.2993030578944396e-33, 2.5884904694776582e-34, 0.025299919734675328, 0.050019977384249945, 0.074230243417954311, 0.097994707148973889, 0.12137153444679591, 0.1444132042747554, 0.1671665070542708, 0.18967238504616593, 0.21196560212718538, 0.23407426030644526, 0.25601905891249116, 0.27781179553793711, 0.29945464524254173, 0.32093967615373742, 0.34226230715830663, 0.36331718651605271, 0.38412469919076048, 0.40485708912530394, 0.42461822424450502, 0.44266070898294529, 0.46914525223595827, 0.48095296144372324, 0.43920578170585739, 0.38197525400078475, 0.34711590048354163, 0.32401648735774147, 0.3043303739155554, 0.28706227940591406, 0.26965826633218165, 0.24541685237366004, 0.18982182918322163, 8.1598009169880321e-33, 2.7730236526826566e-34, 0.024694680136611139, 0.048839309258838233, 0.072502644818742093, 0.095747727712780395, 0.11863219335927251, 0.14120846496329004, 0.16352381535370478, 0.18562028090864349, 0.20753440583909308, 0.22929679412352602, 0.25093148329336795, 0.27245512694271906, 0.29387538624612924, 0.31519063333707054, 0.33637912341998494, 0.35745764753190085, 0.37826606159325832, 0.3988580725057117, 0.41940946046125949, 0.4388015221904959, 0.45698086342290611, 0.48403749267765961, 0.489559630139147, 0.44141764842266218, 0.38606741482715856, 0.35373425175817413, 0.33089018724473279, 0.3105485034452079, 0.29046735593774259, 0.26296129738671215, 0.20166252863197071, 9.0844966170240298e-33, 2.9693826968339136e-34, 0.024081405353597121, 0.047641828513581626, 0.070748383437497994, 0.093462838558547798, 0.11584196976807411, 0.13793780094918037, 0.15979772104558529, 0.18146446360833401, 0.20297593100499922, 0.22436483938824964, 0.24565815280325839, 0.26687630359958309, 0.28803224740411698, 0.30912945740064696, 0.33016553383764052, 0.35109415878401945, 0.3719827364232372, 0.39255544543516485, 0.41299445375240512, 0.43338491106502025, 0.45231729570837659, 0.47109202523367277, 0.49811404060477432, 0.49580897817227126, 0.44220782329585673, 0.38960398700939081, 0.35930678287293233, 0.33583136660234675, 0.31232578984948189, 0.28101497319847857, 0.21349179199517895, 1.0082198106876015e-32, 3.1775721955336007e-34, 0.02346337915519138, 0.046433976455911324, 0.068976986942690582, 0.091152630456861145, 0.11301653566766519, 0.13462001848250238, 0.15601024638449879, 0.17723027677769743, 0.1983189533003496, 0.21931063957999772, 0.24023476383894524, 0.26111513634271805, 0.28196901777747629, 0.30280605895880625, 0.32362480205242949, 0.34442828476517989, 0.36512324422072634, 0.38588697682002349, 0.40621195748494049, 0.42657779095472775, 0.44678825323154236, 0.4652328336272869, 0.48507680237730916, 0.51097239402503547, 0.49964044847615308, 0.44188556855900407, 0.39238816350307909, 0.3628340646166594, 0.33574892496360326, 0.2997849879189059, 0.22540698969614464, 1.1163759792703535e-32, 3.3975968461109969e-34, 0.022843607121453991, 0.045221665241446191, 0.06719722801460648, 0.088828737738788757, 0.11017043045698301, 0.13127264315735016, 0.15218201700990819, 0.17294158702446466, 0.19359074419038791, 0.21416505114551865, 0.23469588711628253, 0.25520989188450682, 0.27572816574881387, 0.29626518839646404, 0.31682784737800002, 0.33740766804871886, 0.35802526519739231, 0.37849799271168988, 0.39922126359593108, 0.41925545239910067, 0.43964945971246017, 0.45961004175508391, 0.47764983619166151, 0.49891196007325783, 0.52213445993609264, 0.50101872082009602, 0.44039541596053194, 0.39324803735206931, 0.36071898133672853, 0.31971342356708921, 0.23754761876493671, 1.2342127680988601e-32, 3.6294613509884068e-34, 0.022224808627740272, 0.044010259412686652, 0.065417091936538399, 0.086501787259522345, 0.1073169851917346, 0.127911811816907, 0.14833211334000868, 0.16862058886245829, 0.1888168104899314, 0.20895711417140789, 0.22907433883494033, 0.24919738510122674, 0.26935055845977629, 0.28955264724733593, 0.30981567014563044, 0.33014463127139587, 0.35051964020622511, 0.37100059566853733, 0.39124187421306772, 0.41204036154579982, 0.43169832316871393, 0.45224051937549126, 0.47183396407983663, 0.48967965601550317, 0.51239944447558039, 0.53099124773305117, 0.49962238219462152, 0.43655514389839162, 0.38805123243054701, 0.340862229428192, 0.25022429309886551, 1.3632890567969843e-32, 3.8731704549176809e-34, 0.021609416032946447, 0.042804571655120735, 0.06364376553453345, 0.08418137623637402, 0.10446828391091408, 0.12455221047627479, 0.14447797620391037, 0.16428766733943939, 0.18402070545327115, 0.2037138044947685, 0.22340079588965911, 0.24311229537605034, 0.26287517790412157, 0.28271181966168513, 0.30263904682662984, 0.32266661381426703, 0.34279911955477205, 0.36299743069979507, 0.38339589213241859, 0.4033681420393036, 0.42440644730072363, 0.44354241399151229, 0.46435935207509055, 0.48343613099492466, 0.50137218286008023, 0.52503019202601697, 0.53650242596499231, 0.49393668422697307, 0.42581480950781425, 0.36344813917611679, 0.26355503983520323, 1.5068846353372252e-32, 4.1287283653351173e-34, 0.020999578584034888, 0.041608867865543478, 0.061883640174924613, 0.081876069366940127, 0.10163515032252413, 0.12120704499340409, 0.14063535441469469, 0.15996131309590039, 0.17922389860420276, 0.19845984483116691, 0.21770354221903984, 0.23698680194014776, 0.25633845352559054, 0.27578373697134972, 0.29534344255767625, 0.31503272633161722, 0.33485906536342402, 0.35482896965240862, 0.37487195598636358, 0.39524826923093903, 0.41487591565574755, 0.43639364396921532, 0.45476960493829893, 0.47596812165190328, 0.49434793696664764, 0.51254169266775829, 0.53560731889033897, 0.5362076045065729, 0.47868506853681725, 0.39358735007054396, 0.27747573386527058, 1.6674239910330083e-32, 4.3961414359069643e-34, 0.020397176300977184, 0.0404268923903712, 0.060142345594086086, 0.079593437789029706, 0.098827187288869994, 0.11788807490689869, 0.13681832480398279, 0.15565811797447124, 0.17444573298304181, 0.19321760470611107, 0.21200828718684003, 0.23085030105840471, 0.24977383905613246, 0.26880629471199613, 0.28797156974826338, 0.30728910893598282, 0.32677259463418656, 0.34642688147817946, 0.3662635922041077, 0.38616454010019075, 0.40658333753204379, 0.42574145300003358, 0.44809105562953933, 0.46531717776566778, 0.48692455544739011, 0.50431292799689098, 0.52232094084657132, 0.54115193285749408, 0.52337442893406372, 0.43758758124092628, 0.29554907049190887, 1.8432592394932737e-32, 4.6754034416117329e-34, 0.019803810923351164, 0.039261846965387218, 0.058424713558810688, 0.077340005130601602, 0.096052704489802909, 0.11460552329887731, 0.13303918501452686, 0.15139264928063786, 0.16970327390025369, 0.18800690708977619, 0.20633789865713908, 0.22472901391382397, 0.24321122816952315, 0.26181337203483401, 0.28056158813778626, 0.2994785489071366, 0.31858238165945363, 0.33788529081431035, 0.35738868124925188, 0.37711302221891413, 0.39687345025198639, 0.41739434599300818, 0.43589614725624515, 0.45959498084152506, 0.47501451163944969, 0.49682204660445467, 0.51245901413027217, 0.52797392624407902, 0.53384564938648826, 0.47916297385693907, 0.32307988634333812, 2.0616751010977557e-32, 4.9665773804635123e-34, 0.019220936513220439, 0.03811665007644955, 0.056735165806733594, 0.075121757626521166, 0.09331933249927131, 0.11136876148096202, 0.12930915947173882, 0.14717811309217518, 0.16501185343611557, 0.1828453673800231, 0.20071243779874748, 0.2186455997255724, 0.23667599589344873, 0.25483310981043117, 0.2731443457589105, 0.29163441236177523, 0.31032445168004813, 0.32923085578854372, 0.34836392749188266, 0.36772016169025712, 0.38733225006668637, 0.40693085021614628, 0.42758379186289203, 0.44516777884264042, 0.47096233141916116, 0.48341781980664283, 0.50455266015510869, 0.51612377882665128, 0.52173760999152519, 0.49282728035862666, 0.35159932826080942, 2.3772792901523305e-32, 5.2693231974441465e-34, 0.018649259238466404, 0.036992739100461206, 0.055075908835762591, 0.072941747210635607, 0.090631096893811547, 0.10818296906024352, 0.12563479844819142, 0.14302264965323372, 0.16038137513387332, 0.17774472281348586, 0.19514538605505757, 0.21261498339468601, 0.23018395274218573, 0.24788134480376831, 0.26573449841021685, 0.28376856987674948, 0.30200586820695507, 0.32046492424291245, 0.33915922009310373, 0.35809607348223699, 0.37726500204894675, 0.39671267802873733, 0.41607478970553913, 0.43680570497571808, 0.45312279137859118, 0.48204863491027894, 0.4893778630743249, 0.50715154869888213, 0.50776414941533854, 0.48260384755778041, 0.36284938966162195, 2.7358263792282517e-32, 5.5857254942317751e-34, 0.018092196145020393, 0.035896912782542152, 0.053457164273223667, 0.070813573505088295, 0.088004733124388751, 0.10506750947676592, 0.12203729330978794, 0.13894819348361861, 0.15583317146284856, 0.1727241172940194, 0.18965186523076288, 0.20664614008803653, 0.22373542268105137, 0.24094673178588427, 0.25830533526294519, 0.27583440452186392, 0.29355459632451841, 0.31148348876202409, 0.32963474307198293, 0.34801684831211077, 0.36663247955050049, 0.38546215253908706, 0.40456569680270998, 0.42348870583893999, 0.44405197737233387, 0.4586516293936953, 0.49203289411496975, 0.48992785346418571, 0.49684381479668116, 0.46708852057730882, 0.35551082705688358, 2.9785703209088503e-32, 5.9027078678851596e-34, 0.017536002397529817, 0.034802259705567155, 0.051838993023273945, 0.06868479393006327, 0.0853766379188165, 0.10194988227974162, 0.11843818357056063, 0.13487332710414562, 0.15128502656368914, 0.16770079896254406, 0.1841460066360831, 0.2006440740422562, 0.21721677755120314, 0.2338844478845527, 0.25066596819456011, 0.26757857000562096, 0.28463752812346793, 0.30185584079884914, 0.31924384798866007, 0.33680858357721843, 0.35455256964792831, 0.37247377216288896, 0.39054440591895601, 0.40883483186024622, 0.42682957107862263, 0.44659746296247038, 0.45891161661951158, 0.49814311486011648, 0.47749828739176298, 0.45373283583837237, 0.34161858575433907, 3.0733563579898369e-32, 6.3058469825963035e-34, 0.017069274826934731, 0.033881531235470705, 0.050476763789463565, 0.066889076988773929, 0.083148083116339755, 0.099280047498650797, 0.11530896975359535, 0.13125737089214681, 0.14714655520607467, 0.16299636020839578, 0.1788246745481189, 0.19464709521431298, 0.21047694386265778, 0.22632557800842085, 0.24220273281214813, 0.25811667040021441, 0.27407415287734466, 0.29008046360726591, 0.30613965274599347, 0.32225486916913021, 0.33842830221464454, 0.35466009589621666, 0.37094865281725964, 0.38726541052520463, 0.40368906231858165, 0.41970226822067597, 0.43738320861808966, 0.44671894596843359, 0.49243592067251085, 0.43315091405526462, 0.32822842627069493, 3.1107792519339245e-32, 6.2114541273814045e-34, 0.016135071144042917, 0.032057363919946964, 0.047785034382800524, 0.063352171684079542, 0.078797707142649942, 0.094158997242710249, 0.10946718080456565, 0.12474261205660439, 0.13999016614596843, 0.15519563772895328, 0.17032521746405188, 0.18532964152788112, 0.2001530479255523, 0.2147444889386621, 0.22906854401840324, 0.24311151373383036, 0.2568814248418182, 0.27040268559441683, 0.28370826534017263, 0.29683263027316004, 0.30980732337065037, 0.3226590724106444, 0.33540879548387487, 0.34807315099589281, 0.3606400243399106, 0.37319341121878613, 0.38529890256524868, 0.39869573157668647, 0.40431560502987396, 0.45402435361089205, 0.3106421051732341, 3.1468366561175804e-32, 9.6403294157344326e-34, 0.018413206382274575, 0.036405199237402826, 0.054089949043184073, 0.071419840127124642, 0.088223314417731513, 0.10425897023541554, 0.11927930652354359, 0.13309190884080566, 0.14560397323152199, 0.15683926094355286, 0.1669244458269806, 0.17605159249195521, 0.1844310555107074, 0.19225092175007882, 0.19965436290838354, 0.20673738545600442, 0.21356099834132988, 0.22016778173143245, 0.22659442032207608, 0.23287686817283396, 0.23904975945904253, 0.24514376985061917, 0.25118367114478607, 0.25718742319036575, 0.26316806224061695, 0.26911649466644977, 0.27508614377836954, 0.28080451616439078, 0.28727454443929507, 0.28890700384527529, 0.33102466011687098, 3.1700007393829046e-32, -6.1461861695563057e-66, -2.1735620347804331e-34, -2.2678458169570631e-34, -1.8550977789958994e-34, -8.4636975654746192e-35, 8.4413025200473847e-35, 3.2817507805201147e-34, 6.4976595399164531e-34, 1.0483390203174961e-33, 1.5196385249387869e-33, 2.057551557215793e-33, 2.6561557942637784e-33, 3.3115328692201212e-33, 4.0227059189262036e-33, 4.7914544184162523e-33, 5.6212696425623747e-33, 6.5160661933057449e-33, 7.4792694775322909e-33, 8.5135788588087787e-33, 9.6212843620352147e-33, 1.0804757830850068e-32, 1.2066770905207337e-32, 1.3410521193088508e-32, 1.4839466541306568e-32, 1.6357128381801952e-32, 1.7966900255498848e-32, 1.9672156083257821e-32, 2.1474359160333924e-32, 2.3380566736852476e-32, 2.5370781527950613e-32, 2.751087284303053e-32, 2.9633235459140848e-32, 3.1637924189812157e-32
    });

    for (std::size_t i = 0; i < expected.size(); ++i) { EXPECT_TRUE(std::abs(pde_.solution()(i)-expected[i]) < 1e-6); }
}

TEST(transport_test, TestCase4) {
    constexpr std::size_t femOrder = 2;

    // define exact solution
    auto solutionExpr = [](SVector<2> x) -> double {
        return 3*sin(x[0]) + 2*x[1];
    };

    SVector<2> b;  b << 1., 1.;
    double mu = 1e-1;

    // non-zero forcing term
    auto forcingExpr = [&mu, &b](SVector<2> x) -> double {
        return 2*b[1] + 3*b[0]*cos(x[0]) + 3*mu*sin(x[0]);
    };
    ScalarField<2> forcing(forcingExpr);   // wrap lambda expression in ScalarField object

    // save parameters in the PDEparameters singleton, these will be retrieved by the solver
    PDEparameters<decltype(mu), decltype(b)>::destroyInstance();
    PDEparameters<decltype(mu), decltype(b)> &PDEparams =
            PDEparameters<decltype(mu), decltype(b)>::getInstance(mu, b);

    auto L = - mu * laplacian<FEM>() + advection<FEM>(b);
    MeshLoader<Mesh2D> unit_square("unit_square_16");

    PDE< decltype(unit_square.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(mu),
            decltype(b)> pde_( unit_square.mesh, L); //, forcing);
    pde_.set_forcing(forcing);

    // compute boundary condition and exact solution
    DMatrix<double> nodes_ = pde_.dof_coords();
    DMatrix<double> dirichletBC(nodes_.rows(), 1);
    DMatrix<double> solution_ex(nodes_.rows(), 1);

    // set exact sol & dirichlet conditions
    for (int i = 0; i < nodes_.rows(); ++i) {
        solution_ex(i) = solutionExpr(nodes_.row(i));
        dirichletBC(i) = solutionExpr(nodes_.row(i));
    }
    pde_.set_dirichlet_bc(dirichletBC);
    pde_.set_stab_param(1.0);
    // init solver and solve differential problem
    pde_.init();
    pde_.solve();

    // check computed error
    DMatrix<double> error_ = solution_ex - pde_.solution();
    double error_L2 = (pde_.mass() * error_.cwiseProduct(error_)).sum();
    EXPECT_TRUE(error_L2 < 1e-7);

    // // storing solution
    // std::ofstream file("fdaPDE_sol.txt");
    // if (file.is_open()){
    //     for(int i = 0; i < pde_.solution().rows(); ++i)
    //         file << pde_.solution()(i) << '\n';
    //     file.close();
    // } else {
    //     std::cerr << "transport test unable to save solution" << std::endl;
    // }
}

// _______________ convergence tests _______________
TEST(transport_test, convergence_test_0) {
    constexpr std::size_t femOrder = 1;

    int num_refinements = 4;
    DMatrix<int> N(num_refinements, 1);   // number of refinements
    N << 16, 32, 64, 128;
    DMatrix<double> order(num_refinements - 1, 1);
    DVector<double> error_L2(num_refinements);
    error_L2.setZero();

    // define PDE parameters
    VectorField<2> b_callable;
    b_callable[0] = [](SVector<2> x) -> double { return std::pow(x[1], 2) + 1; };   // y^2 + 1
    b_callable[1] = [](SVector<2> x) -> double { return 2 * x[0]; };                // 2*x

    double nu = 1e-9;
    double c = 1.;

    constexpr double pi = 3.14159265358979323846;
    auto solutionExpr = [&pi](SVector<2> x) -> double {
        return std::sin(2 * pi * x[0]) * std::sin(2 * pi * x[1]);
    };
    auto forcingExpr = [&pi, &b_callable, &nu, &c](SVector<2> x) -> double {
        return 2*pi*b_callable[0](x)*std::sin(2*pi*x[1])*std::cos(2*pi*x[0])
            + 2*pi*b_callable[1](x)*std::sin(2*pi*x[0])*std::cos(2*pi*x[1])
            + c*std::sin(2*pi*x[0])*std::sin(2*pi*x[1]) + 8*pi*pi*nu*std::sin(2*pi*x[0])*sin(2*pi*x[1]);
    };
    ScalarField<2> forcing(forcingExpr);

    for (int n = 0; n < num_refinements; ++n) {
        std::string domain_name = "unit_square_" + std::to_string(N(n));
        MeshLoader<Mesh2D> domain(domain_name);

        // dicretize b_callable -> discretized_vector_field
        Integrator<FEM, 2, femOrder> integrator;
        DMatrix<double> quad_nodes = integrator.quadrature_nodes(domain.mesh);
        DMatrix<double, Eigen::RowMajor> b_data(quad_nodes.rows(), 2);
        for(int i = 0; i < quad_nodes.rows(); i++) {
            b_data.row(i) = b_callable(SVector<2>(quad_nodes.row(i)));
        }

        // construct discretized transport field together with its divergence
        ScalarField<2> div_b_callable = div(b_callable);
        DVector<double> div_b_data(quad_nodes.rows());
        for(int i = 0; i < quad_nodes.rows(); i++) {
            div_b_data(i) = div_b_callable(SVector<2>(quad_nodes.row(i)));
        }

        DiscretizedVectorField<2,2> b_discretized(b_data, div_b_data);

        PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)>::destroyInstance();
        PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)> &PDEparams =
                PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)>::getInstance(nu, b_discretized, c);

        // define differential operator
        auto L = -nu*laplacian<FEM>() + advection<FEM>(b_discretized) + reaction<FEM>(c);

        // PDE<decltype(unit_square.mesh), decltype(L), DMatrix<double>, FEM, fem_order<1>> pde_(unit_square.mesh, times);
        PDE< decltype(domain.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(nu),
            decltype(b_discretized), decltype(c)> pde_( domain.mesh, L); //, forcing );
        pde_.set_forcing(forcing);

        // compute boundary condition and exact solution
        DMatrix<double> nodes_ = pde_.dof_coords();
        DMatrix<double> dirichletBC(nodes_.rows(), 1);

        DMatrix<double> solution_ex(nodes_.rows(), 1);

        // set dirichlet conditions
        for (int i = 0; i < nodes_.rows(); ++i) {
            solution_ex(i) = solutionExpr(nodes_.row(i));
            dirichletBC(i) = solutionExpr(nodes_.row(i));
        }
        pde_.set_dirichlet_bc(dirichletBC);
        pde_.set_stab_param(2.);

        // init solver and solve differential problem
        pde_.init();
        pde_.solve();

        // check computed error
        DMatrix<double> error_ = solution_ex - pde_.solution();
        error_L2(n) = (pde_.mass() * error_.cwiseProduct(error_)).sum();

        // std::cout << "error_L2 = " << std::setprecision(17) << error_L2(n) << std::endl;
        // //storing solution
        // std::ofstream file("fdaPDE_SUPG_sol.txt");
        // if (file.is_open()){
        //     for(int i = 0; i < pde_.solution().rows(); ++i)
        //         file << pde_.solution()(i) << '\n';
        //     file.close();
        // } else {
        //     std::cerr << "transport test unable to save solution" << std::endl;
        // }
    } // end refinement loop

    for (int nn = 1; nn < num_refinements; ++nn) {
        order(nn - 1) = std::log2(error_L2(nn - 1) / error_L2(nn));
        EXPECT_TRUE(floor(order(nn - 1)) >= 1);
    }
}

TEST(transport_test, convergence_test_1) {
    constexpr std::size_t femOrder = 1;
    double stabParam = 4.705;
    int num_refinements = 4;
    DMatrix<int> N(num_refinements, 1);   // number of refinements
    N << 16, 32, 64, 128;
    DMatrix<double> order(num_refinements - 1, 1);
    DVector<double> error_L2(num_refinements);
    error_L2.setZero();

    // define PDE parameters
    VectorField<2> b_callable;
    b_callable[0] = [](SVector<2> x) -> double { return std::pow(x[1], 2) + 1; };   // y^2 + 1
    b_callable[1] = [](SVector<2> x) -> double { return 2 * x[0]; };                // 2*x

    double nu = 1e-9;
    double c = 1.;

    // define exact solution and forcing
    double BL = 0.1;   // parameter for boundary layer thickness
    auto solutionExpr = [&nu, &BL](SVector<2> x) -> double {
        return x[0]*x[1]*x[1] - x[1]*x[1]*exp((2*(x[0] - 1))/BL) - x[0]*exp(3*(x[1] - 1)/BL) + exp((2*(x[0] - 1) + 3*(x[1] - 1))/BL);
    };
    auto forcingExpr = [&nu, &BL, &b_callable, &c](SVector<2> x) -> double {
        return (BL*BL*c*(x[0]*x[1]*x[1] - x[0]*exp(3*(x[1] - 1)/BL) - x[1]*x[1]*exp(2*(x[0] - 1)/BL) + exp((2*x[0] + 3*x[1] - 5)/BL))
            + BL*(b_callable[0](x)*(BL*(x[1]*x[1] - exp(3*(x[1] - 1)/BL)) - 2*x[1]*x[1]*exp(2*(x[0] - 1)/BL) + 2*exp((2*x[0] + 3*x[1] - 5)/BL))
            + b_callable[1](x)*(2*BL*x[1]*(x[0] - exp(2*(x[0] - 1)/BL)) - 3*x[0]*exp(3*(x[1] - 1)/BL) + 3*exp((2*x[0] + 3*x[1] - 5)/BL)))
            + nu*(2*BL*BL*(-x[0] + exp(2*(x[0] - 1)/BL)) + 9*x[0]*exp(3*(x[1] - 1)/BL) + 4*x[1]*x[1]*exp(2*(x[0] - 1)/BL)
            - 13*exp((2*x[0] + 3*x[1] - 5)/BL)))/(BL*BL);
    };
    ScalarField<2> forcing(forcingExpr);

    for (int n = 0; n < num_refinements; ++n) {
        std::string domain_name = "unit_square_" + std::to_string(N(n));
        MeshLoader<Mesh2D> domain(domain_name);

        // dicretize b_callable -> discretized_vector_field
        Integrator<FEM, 2, femOrder> integrator;
        DMatrix<double> quad_nodes = integrator.quadrature_nodes(domain.mesh);
        DMatrix<double, Eigen::RowMajor> b_data(quad_nodes.rows(), 2);
        for(int i = 0; i < quad_nodes.rows(); i++) {
            b_data.row(i) = b_callable(SVector<2>(quad_nodes.row(i)));
        }

        // construct discretized transport field together with its divergence
        ScalarField<2> div_b_callable = div(b_callable);
        DVector<double> div_b_data(quad_nodes.rows());
        for(int i = 0; i < quad_nodes.rows(); i++) {
            div_b_data(i) = div_b_callable(SVector<2>(quad_nodes.row(i)));
        }

        DiscretizedVectorField<2,2> b_discretized(b_data, div_b_data);

        PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)>::destroyInstance();
        PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)> &PDEparams =
                PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)>::getInstance(nu, b_discretized, c);

        // define differential operator
        auto L = -nu*laplacian<FEM>() + advection<FEM>(b_discretized) + reaction<FEM>(c);

        // PDE<decltype(unit_square.mesh), decltype(L), DMatrix<double>, FEM, fem_order<1>> pde_(unit_square.mesh, times);
        PDE< decltype(domain.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(nu),
            decltype(b_discretized), decltype(c)> pde_( domain.mesh, L); //, forcing );
        pde_.set_forcing(forcing);  

        // compute boundary condition and exact solution
        DMatrix<double> nodes_ = pde_.dof_coords();
        DMatrix<double> dirichletBC(nodes_.rows(), 1);

        DMatrix<double> solution_ex(nodes_.rows(), 1);

        // set dirichlet conditions
        for (int i = 0; i < nodes_.rows(); ++i) {
            solution_ex(i) = solutionExpr(nodes_.row(i));
            dirichletBC(i) = solutionExpr(nodes_.row(i));
        }
        pde_.set_dirichlet_bc(dirichletBC);
        pde_.set_stab_param(stabParam);

        // init solver and solve differential problem
        pde_.init();
        pde_.solve();

        // check computed error
        DMatrix<double> error_ = solution_ex - pde_.solution();
        error_L2(n) = (pde_.mass() * error_.cwiseProduct(error_)).sum();

        // //storing solution
        // std::ofstream file("fdaPDE_SUPG_sol.txt");
        // if (file.is_open()){
        //     for(int i = 0; i < pde_.solution().rows(); ++i)
        //         file << pde_.solution()(i) << '\n';
        //     file.close();
        // } else {
        //     std::cerr << "transport test unable to save solution" << std::endl;
        // }
        // }
    } // end refinement loop

    for (int n = 1; n < num_refinements; ++n) {
        order(n - 1) = std::log2(error_L2(n - 1) / error_L2(n));
        EXPECT_TRUE(floor(order(n - 1)) >= 1);
    }
}

TEST(transport_test, convergence_test_2) {
    constexpr std::size_t femOrder = 2;
    double stabParam = 4.705;
    int num_refinements = 3;
    DMatrix<int> N(num_refinements, 1);   // number of refinements
    N << 16, 32, 64;
    DMatrix<double> order(num_refinements - 1, 1);
    DVector<double> error_L2(num_refinements);
    error_L2.setZero();

    // define PDE parameters
    VectorField<2> b_callable;
    b_callable[0] = [](SVector<2> x) -> double { return std::pow(x[1], 2) + 1; };   // y^2 + 1
    b_callable[1] = [](SVector<2> x) -> double { return 2 * x[0]; };                // 2*x

    double nu = 1e-3;
    double c = 1.;

    // define exact solution and forcing
    double BL = 0.1;   // parameter for boundary layer thickness
    auto solutionExpr = [&nu, &BL](SVector<2> x) -> double {
        return x[0]*x[1]*x[1] - x[1]*x[1]*exp((2*(x[0] - 1))/BL) - x[0]*exp(3*(x[1] - 1)/BL) + exp((2*(x[0] - 1) + 3*(x[1] - 1))/BL);
    };
    auto forcingExpr = [&nu, &BL, &b_callable, &c](SVector<2> x) -> double {
        return (BL*BL*c*(x[0]*x[1]*x[1] - x[0]*exp(3*(x[1] - 1)/BL) - x[1]*x[1]*exp(2*(x[0] - 1)/BL) + exp((2*x[0] + 3*x[1] - 5)/BL))
            + BL*(b_callable[0](x)*(BL*(x[1]*x[1] - exp(3*(x[1] - 1)/BL)) - 2*x[1]*x[1]*exp(2*(x[0] - 1)/BL) + 2*exp((2*x[0] + 3*x[1] - 5)/BL))
            + b_callable[1](x)*(2*BL*x[1]*(x[0] - exp(2*(x[0] - 1)/BL)) - 3*x[0]*exp(3*(x[1] - 1)/BL) + 3*exp((2*x[0] + 3*x[1] - 5)/BL)))
            + nu*(2*BL*BL*(-x[0] + exp(2*(x[0] - 1)/BL)) + 9*x[0]*exp(3*(x[1] - 1)/BL) + 4*x[1]*x[1]*exp(2*(x[0] - 1)/BL)
            - 13*exp((2*x[0] + 3*x[1] - 5)/BL)))/(BL*BL);
    };
    ScalarField<2> forcing(forcingExpr);

    for (int n = 0; n < num_refinements; ++n) {
        std::string domain_name = "unit_square_" + std::to_string(N(n));
        MeshLoader<Mesh2D> domain(domain_name);

        // dicretize b_callable -> discretized_vector_field
        Integrator<FEM, 2, femOrder> integrator;
        DMatrix<double> quad_nodes = integrator.quadrature_nodes(domain.mesh);
        DMatrix<double, Eigen::RowMajor> b_data(quad_nodes.rows(), 2);
        for(int i = 0; i < quad_nodes.rows(); i++) {
            b_data.row(i) = b_callable(SVector<2>(quad_nodes.row(i)));
        }

        // construct discretized transport field together with its divergence
        ScalarField<2> div_b_callable = div(b_callable);
        DVector<double> div_b_data(quad_nodes.rows());
        for(int i = 0; i < quad_nodes.rows(); i++) {
            div_b_data(i) = div_b_callable(SVector<2>(quad_nodes.row(i)));
        }

        DiscretizedVectorField<2,2> b_discretized(b_data, div_b_data);

        PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)>::destroyInstance();
        PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)> &PDEparams =
                PDEparameters<decltype(nu), decltype(b_discretized), decltype(c)>::getInstance(nu, b_discretized, c);

        // define differential operator
        auto L = -nu*laplacian<FEM>() + advection<FEM>(b_discretized) + reaction<FEM>(c);

        PDE< decltype(domain.mesh), decltype(L), ScalarField<2>, FEM, fem_order<femOrder>, decltype(nu),
            decltype(b_discretized), decltype(c)> pde_( domain.mesh, L); //, forcing );
        pde_.set_forcing(forcing);

        // compute boundary condition and exact solution
        DMatrix<double> nodes_ = pde_.dof_coords();
        DMatrix<double> dirichletBC(nodes_.rows(), 1);

        DMatrix<double> solution_ex(nodes_.rows(), 1);

        // set dirichlet conditions
        for (int i = 0; i < nodes_.rows(); ++i) {
            solution_ex(i) = solutionExpr(nodes_.row(i));
            dirichletBC(i) = solutionExpr(nodes_.row(i));
        }
        pde_.set_dirichlet_bc(dirichletBC);
        pde_.set_stab_param(stabParam);

        // init solver and solve differential problem
        pde_.init();
        pde_.solve();

        // check computed error
        DMatrix<double> error_ = solution_ex - pde_.solution();
        error_L2(n) = (pde_.mass() * error_.cwiseProduct(error_)).sum();

        // std::cout << "error_L2 = " << std::setprecision(17) << error_L2(n) << std::endl;
        // //storing solution
        // std::ofstream file("fdaPDE_SUPG_sol.txt");
        // if (file.is_open()){
        //     for(int i = 0; i < pde_.solution().rows(); ++i)
        //         file << pde_.solution()(i) << '\n';
        //     file.close();
        // } else {
        //     std::cerr << "transport test unable to save solution" << std::endl;
        // }
    } // end refinement loop

    for (int n = 1; n < num_refinements; ++n) {
        order(n - 1) = std::log2(error_L2(n - 1) / error_L2(n));
        EXPECT_TRUE(floor(order(n - 1)) >= 2);
    }
}